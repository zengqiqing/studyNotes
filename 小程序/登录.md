## 小程序登录流程

2020年 10月 10日

<img src="/Users/cole/Library/Application Support/typora-user-images/image-20201010100419719.png" alt="image-20201010100419719" style="zoom:50%;" />

1.前端调用wx.login获取临时登录凭证code值(code值的有效期只有五分钟)，调用后端提供的接口，把code值回传给后端，一个code只能换取一次session_key，每次调用wx.login()，都会下发一个新的code和对应的session_key，开发者应该要清楚用户需要重新登录的时候才去调用wx.login.

2.后端需要调用微信提供的第三方接口https://api.weixin.qq.com/sns/jscode2session，换取用户唯一标识openID和session_key，session_key是微信服务端派发的

（为啥要服务端请求这个第三方接口呢，主要是为了安全性考虑，如果前端调用的话，小程序的appid和小程序的secret就会暴露在外部，就是在传参给后端的时候暴露了，并且微信端派发的session_key会直接暴露不经处理地给前端， 那么这样容易遭受不法分子攻击）

Session_key也是会过期的，但过期时间与用户使用小程序的频率成正比，具体过期时间开发者和用户是获取不到的，我们可以通过checkSession去检测session_key是否过期





## 小程序登录优化

##### 场景：

用户拒绝授权后，短时间内再次调用微信用户信息接口时，微信不会再向用户展示授权弹窗，这样导致用户只要拒绝过一次，即使后来对小程序感兴趣了愿意授权了，也难以再次操作，

##### 提问：
如何再次打开授权任务呢？？

##### 回答：
 判断用户是否近期拒绝授权，若为拒绝授权导致，则提示并打开权限面板，供用户再次操作

---------------------------------------------------------------------------

##### 场景：

session_key的失效时间开发者不能控制，前端需要用wx.checkSession来检查session_key的有效性，（实践中wx.checkSession平均耗时大约200ms，开销挺大的）；同时前端不能随便重新执行微信的登录接口的，这可能会导致正在进行的其他后端任务session_key失效的

##### 提问：

如何保证接口的功能正确切有效并且如何减少wx.checkSession的高额查询开销呢？

##### 回答：

1.先校验前端登录状态，不作后端和微信的登录状态校验，以节省校验开销（判断一下是否有存储过session_key,token等登录信息）

2.接口调用后校验后端以及微信的登录状态，如果后端返回相关登录状态的错误码，则重置前端登录状态，进行重新登录接口的调用和存储，这样就只在真正需要登录时才去执行登录流程，否则不主动进行session_key的登录状态校验



